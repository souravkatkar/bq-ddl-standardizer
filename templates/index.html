<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BQ DDL Standardizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #F4F6F8;
            color: #212529;
        }
        .left-panel {
            background: #fff;
            border-right: 1px solid #e3e6ea;
            min-height: 100vh;
            padding: 2.5rem 2rem 2rem 2rem;
        }
        .right-panel {
            background: #fff;
            min-height: 100vh;
            padding: 2.5rem 2rem 2rem 2rem;
        }
        .form-label, h5 {
            color: #212529;
            font-weight: 500;
            margin-bottom: 0.75rem;
        }
        .form-control, .form-select {
            background: #F4F6F8;
            color: #212529;
            border: 1px solid #e3e6ea;
            margin-bottom: 1.25rem;
        }
        .nav-tabs {
            background: #F4F6F8;
            border-bottom: 1px solid #e3e6ea;
            margin-bottom: 1.5rem;
        }
        .nav-tabs .nav-link {
            color: #0D6EFD;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            background: #fff;
            color: #0D6EFD;
            border-color: #e3e6ea #e3e6ea #fff;
        }
        .tab-content {
            background: #fff;
            border-radius: 0 0 8px 8px;
            border: 1px solid #e3e6ea;
            box-shadow: 0 2px 12px rgba(60,64,67,0.04);
            margin-bottom: 2rem;
            padding: 2rem 2rem 2rem 2rem;
        }
        #browse_json_schema {
            background: #F4F6F8;
            border: 1px solid #dee2e6;
            padding: 1.5em;
            min-height: 300px;
            max-height: 350px;
            overflow: auto;
            font-size: 1em;
            color: #212529;
            margin-bottom: 1.5rem;
        }
        .btn,
        .btn-primary,
        .btn-success {
            min-width: 160px;
            max-width: 200px;
            width: 200px;
            box-sizing: border-box;
            margin-bottom: 1rem;
            text-align: left;
        }
        .row {
            margin-bottom: 1.5rem;
        }
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            margin-bottom: 2rem;
        }
        .toast-container .toast {
            background: #34A853;
            color: #fff;
        }
        .btn-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .page-title {
            text-align: center;
            font-size: 1.6rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0px 0 0px 0;
            letter-spacing: 0.5px;
            line-height: 0.2;
            padding: 0;
        }
        .container-fluid.heading-container {
            margin-bottom: 0.5rem;
        }
        @media (min-width: 992px) {
            .left-panel {
                flex: 0 0 22%;
                max-width: 22%;
            }
            .right-panel {
                flex: 0 0 78%;
                max-width: 78%;
            }
        }
        @media (max-width: 991px) {
            .left-panel, .right-panel {
                max-width: 100%;
                min-width: 100%;
                border-right: none;
                border-bottom: 1px solid #e3e6ea;
                min-height: auto;
                padding-top: 1rem;
            }
        }
        .toast-container {
            top: 1rem !important;
            right: 1rem !important;
            left: auto !important;
            transform: none !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4 heading-container">
        <div class="row">
            <div class="col-12">
                <h1 class="page-title">BigQuery DDL Standardizer</h1>
            </div>
        </div>
    </div>
    <div aria-live="polite" aria-atomic="true" class="position-relative">
      <div class="toast-container position-fixed p-3" style="z-index: 1080;">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% set category, message = messages[-1] %}
            <div id="flashToast" class="toast align-items-center text-bg-{{ 'success' if category == 'success' else 'danger' if category == 'danger' else 'warning' }} border-0" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="d-flex">
                <div class="toast-body">
                  {{ message }}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
            </div>
          {% endif %}
        {% endwith %}
      </div>
    </div>
    <div class="container-fluid mt-5">
        <div class="row">
            <!-- Left Panel: Source System Connection -->
            <div class="col-md-4 left-panel border-end">
                <div class="d-flex align-items-center mb-3">
                    <h5 class="me-3">Source Connection</h5>
                </div>
                <form id="sourceConnectionForm" method="post" action="/connect">
                    <div class="mb-3">
                        <label for="db_system" class="form-label">Database System</label>
                        <select name="db_system" id="db_system" class="form-select" onchange="updateFormAction()" aria-label="Select source system">
                            <option value="" {% if not db_system %}selected{% endif %}>Select source system</option>
                            <option value="mysql" {% if db_system == "mysql" %}selected{% endif %}>MySQL</option>
                            <option value="postgresql" {% if db_system == "postgresql" %}selected{% endif %}>PostgreSQL</option>
                            <option value="sqlserver" {% if db_system == "sqlserver" %}selected{% endif %}>SQL Server</option>
                            <option value="oracle" {% if db_system == "oracle" %}selected{% endif %}>Oracle</option>
                            <option value="snowflake" disabled style="color: #888;">Snowflake (coming soon)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="host" class="form-label">Host</label>
                        <input type="text" class="form-control" id="host" name="host" placeholder="e.g. localhost" value="{{ host }}">
                    </div>
                    <div class="mb-3">
                        <label for="port" class="form-label">Port</label>
                        <input type="text" class="form-control" id="port" name="port" placeholder="e.g. 3306" value="{{ port }}">
                    </div>
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" name="username" placeholder="Username" value="{{ username }}">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password" placeholder="Password">
                    </div>
                    <div class="mb-3" id="oracle-service-sid-group" style="display: none;">
                        <label for="service_name" class="form-label">SID / Service Name</label>
                        <input type="text" class="form-control" id="service_name" name="service_name"
                               placeholder="e.g. ORCL or ORCLPDB1"
                               value="{{ service_name or database or '' }}">
                    </div>
                    <div class="btn-row mt-3">
                        <button type="submit" class="btn btn-primary">Connect</button>
                        <button type="button" class="btn btn-primary" onclick="clearConnectionForm()">Clear</button>
                    </div>
                </form>
                <!-- Add below the Source Connection form in the sidebar (left-panel) -->
                <div class="mb-4 mt-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="use_ai_toggle" onchange="toggleAIOptions()">
                        <label class="form-check-label" for="use_ai_toggle">Use AI</label>
                    </div>
                    <div id="ai-model-group" style="display:none; margin-top:1rem;">
                        <label for="ai_model_select" class="form-label">Select AI Model</label>
                        <select class="form-select" id="ai_model_select" name="ai_model">
                            <option value="">Loading models...</option>
                        </select>
                    </div>
                </div>
            </div>
            <!-- Right Panel: Tabs -->
            <div class="col-md-8 right-panel">
                <ul class="nav nav-tabs" id="ddlTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if active_tab != 'browse' %}active{% endif %}" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab" aria-controls="manual" aria-selected="{{ 'true' if active_tab != 'browse' else 'false' }}">Manual</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if active_tab == 'browse' %}active{% endif %}" id="browse-tab" data-bs-toggle="tab" data-bs-target="#browse" type="button" role="tab" aria-controls="browse" aria-selected="{{ 'true' if active_tab == 'browse' else 'false' }}">Browse Source</button>
                    </li>
                </ul>
                <div class="tab-content" id="ddlTabContent">
                    <!-- Manual Tab -->
                    <div class="tab-pane fade {% if active_tab != 'browse' %}show active{% endif %}" id="manual" role="tabpanel" aria-labelledby="manual-tab">
                        <div class="mt-4"></div>
                        <form method="POST" action="/generate">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="json_schema" class="form-label">Source JSON Schema (with db and schema)</label>
                                    <textarea class="form-control mb-2" id="json_schema" name="json_schema" rows="12" placeholder='Paste JSON schema here...' oninput="updateBQTableNameFromJSON()">{{ json_schema_text or '' }}</textarea>
                                    <button type="button" class="btn btn-primary" onclick="clearTextarea('json_schema')">Clear</button>
                                </div>
                                <div class="col-md-6">
                                    <label for="source_ddl" class="form-label">Source DDL (optional)</label>
                                    <textarea class="form-control mb-2" id="source_ddl" name="source_ddl" rows="12" placeholder="Paste your source DDL here..." oninput="clearTextarea('json_schema')">{{ source_ddl_text or '' }}</textarea>
                                    <button type="button" class="btn btn-primary" onclick="clearTextarea('source_ddl')">Clear</button>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <label for="bq_project_id" class="form-label">BigQuery Project ID</label>
                                    <input type="text" class="form-control" id="bq_project_id" name="bq_project_id" placeholder="Enter BigQuery Project ID" value="my-bq-project">
                                </div>
                                <div class="col-md-4">
                                    <label for="bq_dataset_id" class="form-label">BigQuery Dataset ID</label>
                                    <input type="text" class="form-control" id="bq_dataset_id" name="bq_dataset_id" placeholder="Enter BigQuery Dataset ID" value="hr">
                                </div>
                                <div class="col-md-4">
                                    <label for="bq_table_name" class="form-label">BigQuery Table Name</label>
                                    <input type="text" class="form-control" id="bq_table_name" name="bq_table_name" placeholder="Enter BigQuery Table Name" value="{{ bq_table_name or '' }}">
                                </div>
                            </div>
                            <div class="mb-2 text-muted mt-2" style="font-size:0.95em;">
                                <span>Provide either a JSON schema or a source DDL. If both are provided, JSON schema will be used. If JSON schema is empty, table name will be taken from DDL and extracted schema will be shown here.</span>
                            </div>
                            <button type="submit" class="btn btn-primary">Generate DDL</button>
                        </form>
                        {% if ddl and active_tab != 'browse' %}
                        <div class="mt-4" id="bq_ddl_preview_manual">
                            <h5>Preview: Generated BigQuery DDL</h5>
                            <pre style="background:#f8f9fa; border:1px solid #dee2e6; padding:1em;">{{ ddl }}</pre>
                            <div class="btn-row">
                                <a href="data:text/sql;charset=utf-8,{{ ddl | urlencode }}" download="bigquery_ddl.sql" class="btn btn-primary mt-2" id="downloadDDLBtnManual">Download SQL file</a>
                                <button type="button" class="btn btn-secondary mt-2" id="standardizeDDLBtnManual" disabled>Standardize DDL</button>
                                <button type="button" class="btn btn-secondary mt-2" id="addCommentsDDLBtnManual" disabled>Add Comments to DDL</button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <!-- Browse Source Tab -->
                    <div class="tab-pane fade {% if active_tab == 'browse' %}show active{% endif %}" id="browse" role="tabpanel" aria-labelledby="browse-tab">
                        {% set not_connected = not (mysql_connected or postgresql_connected or sqlserver_connected or oracle_connected) %}
                        {% if not_connected %}
                            <div class="alert alert-warning mt-4" role="alert">
                                <strong>Notice:</strong> Please connect to a source system before accessing the Browse section.
                            </div>
                        {% endif %}
                        <form id="browseSourceForm" onsubmit="return false;">
                            <div class="row mt-3">
                                {% if db_system == "mysql" %}
                                    <div class="col-md-6">
                                        <label for="browse_database" class="form-label">Database</label>
                                        <select class="form-select" id="browse_database" name="browse_database" onchange="loadMysqlTables(); clearJsonSchema();" {% if not mysql_connected %}disabled{% endif %}>
                                            <option value="">Select database...</option>
                                            {% for db in mysql_dbs %}
                                                <option value="{{ db }}" {% if db == database %}selected{% endif %}>{{ db }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="browse_table" class="form-label">Table</label>
                                        <select class="form-select" id="browse_table" name="browse_table" onchange="clearJsonSchema();" {% if not mysql_connected %}disabled{% endif %}>
                                            <option value="">Select table...</option>
                                        </select>
                                    </div>
                                {% elif db_system == "postgresql" %}
                                    <div class="col-md-4">
                                        <label for="browse_database" class="form-label">Database</label>
                                        <select class="form-select" id="browse_database" name="browse_database" onchange="loadPostgresSchemas(); clearJsonSchema();" {% if not postgresql_connected %}disabled{% endif %}>
                                            <option value="">Select database...</option>
                                            {% for db in postgresql_dbs %}
                                                <option value="{{ db }}" {% if db == database %}selected{% endif %}>{{ db }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="browse_schema" class="form-label">Schema</label>
                                        <select class="form-select" id="browse_schema" name="browse_schema" onchange="loadPostgresTables(); clearJsonSchema();" {% if not postgresql_connected %}disabled{% endif %}>
                                            <option value="">Select schema...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="browse_table" class="form-label">Table</label>
                                        <select class="form-select" id="browse_table" name="browse_table" onchange="clearJsonSchema();" {% if not postgresql_connected %}disabled{% endif %}>
                                            <option value="">Select table...</option>
                                        </select>
                                    </div>
                                {% elif db_system == "sqlserver" %}
                                    <div class="col-md-4">
                                        <label for="browse_database" class="form-label">Database</label>
                                        <select class="form-select" id="browse_database" name="browse_database" onchange="loadSqlServerSchemas(); clearJsonSchema();" {% if not sqlserver_connected %}disabled{% endif %}>
                                            <option value="">Select database...</option>
                                            {% for db in sqlserver_dbs %}
                                                <option value="{{ db }}" {% if db == database %}selected{% endif %}>{{ db }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="browse_schema" class="form-label">Schema</label>
                                        <select class="form-select" id="browse_schema" name="browse_schema" onchange="loadSqlServerTables(); clearJsonSchema();" {% if not sqlserver_connected %}disabled{% endif %}>
                                            <option value="">Select schema...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="browse_table" class="form-label">Table</label>
                                        <select class="form-select" id="browse_table" name="browse_table" onchange="clearJsonSchema();" {% if not sqlserver_connected %}disabled{% endif %}>
                                            <option value="">Select table...</option>
                                        </select>
                                    </div>
                                {% elif db_system == "oracle" %}
                                    <div class="col-md-4">
                                        <label for="browse_schema" class="form-label">Schema</label>
                                        <select class="form-select" id="browse_schema" name="browse_schema" onchange="loadOracleTables(); clearJsonSchema();" {% if not oracle_connected %}disabled{% endif %}>
                                            <option value="">Select schema...</option>
                                            <!-- JS will populate options -->
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="browse_table" class="form-label">Table</label>
                                        <select class="form-select" id="browse_table" name="browse_table" onchange="clearJsonSchema();" {% if not oracle_connected %}disabled{% endif %}>
                                            <option value="">Select table...</option>
                                        </select>
                                    </div>
                                {% endif %}
                                <div class="col-md-12 mt-2">
                                    <button type="button" class="btn btn-primary" onclick="getSchemaFromBrowse()" id="getSchemaBtn" {% if not_connected %}disabled{% endif %}>Get Schema</button>
                                </div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-md-12">
                                    <h6>Source JSON Schema</h6>
                                    <pre id="browse_json_schema"></pre>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <label for="bq_project_id_browse" class="form-label">BigQuery Project ID</label>
                                    <input type="text" class="form-control" id="bq_project_id_browse" name="bq_project_id" placeholder="Enter BigQuery Project ID" value="my-bq-project" {% if not_connected %}disabled{% endif %}>
                                </div>
                                <div class="col-md-4">
                                    <label for="bq_dataset_id_browse" class="form-label">BigQuery Dataset ID</label>
                                    <input type="text" class="form-control" id="bq_dataset_id_browse" name="bq_dataset_id" placeholder="Enter BigQuery Dataset ID" value="hr" {% if not_connected %}disabled{% endif %}>
                                </div>
                                <div class="col-md-4">
                                    <label for="bq_table_name_browse" class="form-label">BigQuery Table Name</label>
                                    <input type="text" class="form-control" id="bq_table_name_browse" name="bq_table_name" placeholder="Enter BigQuery Table Name" value="" {% if not_connected %}disabled{% endif %}>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <button type="button" class="btn btn-primary" onclick="generateDDLFromSchema()" id="generateDDLBtn" {% if not_connected %}disabled{% endif %}>Generate DDL</button>
                                </div>
                            </div>
                        </form>
                        <div id="bq_ddl_preview" class="mt-4" style="display:none;">
                            <h5>Preview: Generated BigQuery DDL</h5>
                            <pre style="background:#f8f9fa; border:1px solid #dee2e6; padding:1em;"></pre>
                            <div class="btn-row">
                                <a href="#" class="btn btn-primary mt-2" id="downloadDDLBtn" style="display:none;" download>Download SQL file</a>
                                <button type="button" class="btn btn-secondary mt-2" id="standardizeDDLBtn" disabled>Standardize DDL</button>
                                <button type="button" class="btn btn-secondary mt-2" id="addCommentsDDLBtn" disabled>Add Comments to DDL</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ai_util.js') }}"></script>
</body>
</html>