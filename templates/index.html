<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BQ DDL Standardizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #browse_json_schema {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 1em;
            min-height: 300px;
            max-height: 350px;
            overflow: auto;
            font-size: 1em;
        }
        @media (min-width: 992px) {
            .left-panel {
                flex: 0 0 22%;
                max-width: 22%;
            }
            .right-panel {
                flex: 0 0 78%;
                max-width: 78%;
            }
        }
    </style>
</head>
<body>
<div class="container-fluid mt-5">
    <div class="row">
        <!-- Left Panel: Source System Connection -->
        <div class="col-md-4 left-panel border-end">
            <h4 class="mb-3">Source System Connection</h4>
            <form method="POST" action="/connect">
                <div class="mb-3">
                    <label for="db_system" class="form-label">Database System</label>
                    <select class="form-select" id="db_system" name="db_system" required>
                        <option value="">Select...</option>
                        <option value="mysql" {% if db_system == "mysql" %}selected{% endif %}>MySQL</option>
                        <option value="postgresql" {% if db_system == "postgresql" %}selected{% endif %}>PostgreSQL</option>
                        <option value="sqlserver" {% if db_system == "sqlserver" %}selected{% endif %}>SQL Server</option>
                        <option value="oracle" {% if db_system == "oracle" %}selected{% endif %}>Oracle</option>
                        <option value="snowflake" {% if db_system == "snowflake" %}selected{% endif %}>Snowflake</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="host" class="form-label">Host</label>
                    <input type="text" class="form-control" id="host" name="host" placeholder="e.g. localhost" value="{{ host or '' }}">
                </div>
                <div class="mb-3">
                    <label for="port" class="form-label">Port</label>
                    <input type="text" class="form-control" id="port" name="port" placeholder="e.g. 3306" value="{{ port or '' }}">
                </div>
                <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" class="form-control" id="username" name="username" placeholder="Username" value="{{ username or '' }}">
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" name="password" placeholder="Password">
                </div>
                <div class="mb-3">
                    <label for="database" class="form-label">Database Name</label>
                    <input type="text" class="form-control" id="database" name="database" placeholder="Database Name" value="{{ database or '' }}">
                </div>
                <button type="submit" class="btn btn-primary w-100">Connect</button>
            </form>
        </div>
        <!-- Right Panel: Tabs -->
        <div class="col-md-8 right-panel">
            <ul class="nav nav-tabs" id="ddlTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if active_tab != 'browse' %}active{% endif %}" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab" aria-controls="manual" aria-selected="{{ 'true' if active_tab != 'browse' else 'false' }}">Manual</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if active_tab == 'browse' %}active{% endif %}" id="browse-tab" data-bs-toggle="tab" data-bs-target="#browse" type="button" role="tab" aria-controls="browse" aria-selected="{{ 'true' if active_tab == 'browse' else 'false' }}">Browse Source</button>
                </li>
            </ul>
            <div class="tab-content" id="ddlTabContent">
                <!-- Manual Tab -->
                <div class="tab-pane fade {% if active_tab != 'browse' %}show active{% endif %}" id="manual" role="tabpanel" aria-labelledby="manual-tab">
                    <form method="POST" action="/generate">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="json_schema" class="form-label">Source JSON Schema (with db and schema)</label>
                                <textarea class="form-control mb-2" id="json_schema" name="json_schema" rows="12" placeholder='Paste JSON schema here...' oninput="updateBQTableNameFromJSON()">{{ json_schema_text or '' }}</textarea>
                                <button type="button" class="btn btn-primary btn-sm mb-3" onclick="clearTextarea('json_schema')">Clear</button>
                            </div>
                            <div class="col-md-6">
                                <label for="source_ddl" class="form-label">Source DDL (optional)</label>
                                <textarea class="form-control mb-2" id="source_ddl" name="source_ddl" rows="12" placeholder="Paste your source DDL here..." oninput="clearTextarea('json_schema')">{{ source_ddl_text or '' }}</textarea>
                                <button type="button" class="btn btn-primary btn-sm mb-3" onclick="clearTextarea('source_ddl')">Clear</button>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label for="bq_project_id" class="form-label">BigQuery Project ID</label>
                                <input type="text" class="form-control" id="bq_project_id" name="bq_project_id" placeholder="Enter BigQuery Project ID" value="my-bq-project">
                            </div>
                            <div class="col-md-4">
                                <label for="bq_dataset_id" class="form-label">BigQuery Dataset ID</label>
                                <input type="text" class="form-control" id="bq_dataset_id" name="bq_dataset_id" placeholder="Enter BigQuery Dataset ID" value="hr">
                            </div>
                            <div class="col-md-4">
                                <label for="bq_table_name" class="form-label">BigQuery Table Name</label>
                                <input type="text" class="form-control" id="bq_table_name" name="bq_table_name" placeholder="Enter BigQuery Table Name" value="{{ bq_table_name or '' }}">
                            </div>
                        </div>
                        <div class="mb-2 text-muted mt-2" style="font-size:0.95em;">
                            <span>Provide either a JSON schema or a source DDL. If both are provided, JSON schema will be used. If JSON schema is empty, table name will be taken from DDL and extracted schema will be shown here.</span>
                        </div>
                        <button type="submit" class="btn btn-primary">Generate DDL</button>
                    </form>
                    {% if ddl and active_tab != 'browse' %}
                    <div class="mt-4">
                        <h5>Preview: Generated BigQuery DDL</h5>
                        <pre style="background:#f8f9fa; border:1px solid #dee2e6; padding:1em;">{{ ddl }}</pre>
                        <a href="{{ filename }}" class="btn btn-success mt-2" download>Download SQL file</a>
                    </div>
                    {% endif %}
                </div>
                <!-- Browse Source Tab -->
                <div class="tab-pane fade {% if active_tab == 'browse' %}show active{% endif %}" id="browse" role="tabpanel" aria-labelledby="browse-tab">
                    <form id="browseSourceForm" onsubmit="return false;">
                        <div class="row mt-3">
                            {% if db_system == "mysql" and mysql_connected %}
                                <div class="col-md-6">
                                    <label for="browse_database" class="form-label">Database</label>
                                    <select class="form-select" id="browse_database" name="browse_database" onchange="loadMysqlTables(); clearJsonSchema();">
                                        <option value="">Select database...</option>
                                        {% for db in mysql_dbs %}
                                            <option value="{{ db }}" {% if db == database %}selected{% endif %}>{{ db }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="browse_table" class="form-label">Table</label>
                                    <select class="form-select" id="browse_table" name="browse_table" onchange="clearJsonSchema();">
                                        <option value="">Select table...</option>
                                    </select>
                                </div>
                            {% elif db_system == "postgresql" and postgresql_connected %}
                                <div class="col-md-4">
                                    <label for="browse_database" class="form-label">Database</label>
                                    <select class="form-select" id="browse_database" name="browse_database" onchange="loadPostgresSchemas(); clearJsonSchema();">
                                        <option value="">Select database...</option>
                                        {% for db in postgresql_dbs %}
                                            <option value="{{ db }}" {% if db == database %}selected{% endif %}>{{ db }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="browse_schema" class="form-label">Schema</label>
                                    <select class="form-select" id="browse_schema" name="browse_schema" onchange="loadPostgresTables(); clearJsonSchema();">
                                        <option value="">Select schema...</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="browse_table" class="form-label">Table</label>
                                    <select class="form-select" id="browse_table" name="browse_table" onchange="clearJsonSchema();">
                                        <option value="">Select table...</option>
                                    </select>
                                </div>
                            {% endif %}
                            <div class="col-md-12 mt-2">
                                <button type="button" class="btn btn-primary" onclick="getSchemaFromBrowse()">Get Schema</button>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <h6>Source JSON Schema</h6>
                                <pre id="browse_json_schema"></pre>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label for="bq_project_id_browse" class="form-label">BigQuery Project ID</label>
                                <input type="text" class="form-control" id="bq_project_id_browse" name="bq_project_id" placeholder="Enter BigQuery Project ID" value="my-bq-project">
                            </div>
                            <div class="col-md-4">
                                <label for="bq_dataset_id_browse" class="form-label">BigQuery Dataset ID</label>
                                <input type="text" class="form-control" id="bq_dataset_id_browse" name="bq_dataset_id" placeholder="Enter BigQuery Dataset ID" value="hr">
                            </div>
                            <div class="col-md-4">
                                <label for="bq_table_name_browse" class="form-label">BigQuery Table Name</label>
                                <input type="text" class="form-control" id="bq_table_name_browse" name="bq_table_name" placeholder="Enter BigQuery Table Name" value="">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <button type="button" class="btn btn-primary" onclick="generateDDLFromSchema()" id="generateDDLBtn" disabled>Generate DDL</button>
                            </div>
                        </div>
                    </form>
                    <div id="bq_ddl_preview" class="mt-4" style="display:none;">
                        <h5>Preview: Generated BigQuery DDL</h5>
                        <pre style="background:#f8f9fa; border:1px solid #dee2e6; padding:1em;"></pre>
                        <a href="#" class="btn btn-success mt-2" id="downloadDDLBtn" style="display:none;" download>Download SQL file</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
function loadMysqlTables() {
    const db = document.getElementById('browse_database').value;
    if (!db) {
        document.getElementById('browse_table').innerHTML = '<option value="">Select table...</option>';
        clearJsonSchema();
        return;
    }
    document.getElementById('browse_table').innerHTML = '<option>Loading...</option>';
    fetch(`/get_mysql_tables?database=${encodeURIComponent(db)}`)
        .then(response => response.json())
        .then(data => {
            let options = '<option value="">Select table...</option>';
            for (const tbl of data) {
                options += `<option value="${tbl}">${tbl}</option>`;
            }
            document.getElementById('browse_table').innerHTML = options;
            clearJsonSchema();
        })
        .catch(() => {
            document.getElementById('browse_table').innerHTML = '<option value="">Select table...</option>';
            clearJsonSchema();
        });
}

function loadPostgresSchemas() {
    const db = document.getElementById('browse_database').value;
    if (!db) {
        document.getElementById('browse_schema').innerHTML = '<option value="">Select schema...</option>';
        document.getElementById('browse_table').innerHTML = '<option value="">Select table...</option>';
        clearJsonSchema();
        return;
    }
    fetch(`/get_postgres_schemas?database=${encodeURIComponent(db)}`)
        .then(response => response.json())
        .then(data => {
            let options = '<option value="">Select schema...</option>';
            for (const schema of data) {
                options += `<option value="${schema}">${schema}</option>`;
            }
            document.getElementById('browse_schema').innerHTML = options;
            document.getElementById('browse_table').innerHTML = '<option value="">Select table...</option>';
            clearJsonSchema();
        });
}

function loadPostgresTables() {
    const db = document.getElementById('browse_database').value;
    const schema = document.getElementById('browse_schema').value;
    if (!db || !schema) {
        document.getElementById('browse_table').innerHTML = '<option value="">Select table...</option>';
        clearJsonSchema();
        return;
    }
    fetch(`/get_postgres_tables?database=${encodeURIComponent(db)}&schema=${encodeURIComponent(schema)}`)
        .then(response => response.json())
        .then(data => {
            let options = '<option value="">Select table...</option>';
            for (const tbl of data) {
                options += `<option value="${tbl}">${tbl}</option>`;
            }
            document.getElementById('browse_table').innerHTML = options;
            clearJsonSchema();
        });
}

function clearJsonSchema() {
    document.getElementById('browse_json_schema').textContent = "";
    document.getElementById('generateDDLBtn').disabled = true;
    document.getElementById('bq_ddl_preview').style.display = 'none';
    document.getElementById('bq_ddl_preview').querySelector('pre').textContent = "";
    document.getElementById('bq_table_name_browse').value = "";
}

document.addEventListener("DOMContentLoaded", function() {
    clearJsonSchema();
    var browseTable = document.getElementById('browse_table');
    var bqTableName = document.getElementById('bq_table_name_browse');
    if (browseTable && bqTableName) {
        browseTable.addEventListener('change', function() {
            bqTableName.value = browseTable.value;
        });
    }
    {% if active_tab == 'browse' and mysql_connected and database %}
    loadMysqlTables();
    {% endif %}
    {% if active_tab == 'browse' %}
    var browseTab = document.getElementById('browse-tab');
    if (browseTab) {
        var tab = new bootstrap.Tab(browseTab);
        tab.show();
    }
    {% endif %}
});

function getSchemaFromBrowse() {
    const dbSystem = "{{ db_system }}";
    const db = document.getElementById('browse_database').value;
    const tbl = document.getElementById('browse_table').value;
    if (dbSystem === "postgresql") {
        const schema = document.getElementById('browse_schema').value;
        if (!db || !schema || !tbl) {
            alert("Please select database, schema, and table.");
            return;
        }
        fetch(`/get_postgres_schema?database=${encodeURIComponent(db)}&schema=${encodeURIComponent(schema)}&table=${encodeURIComponent(tbl)}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('browse_json_schema').textContent = JSON.stringify(data.schema, null, 4);
                document.getElementById('bq_table_name_browse').value = data.schema.table_name || '';
                document.getElementById('generateDDLBtn').disabled = false;
                document.getElementById('bq_ddl_preview').style.display = 'none';
            });
    } else {
        // MySQL
        if (!db || !tbl) {
            alert("Please select both database and table.");
            return;
        }
        fetch(`/get_mysql_schema?database=${encodeURIComponent(db)}&table=${encodeURIComponent(tbl)}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('browse_json_schema').textContent = JSON.stringify(data.schema, null, 4);
                document.getElementById('bq_table_name_browse').value = data.schema.table_name || '';
                document.getElementById('generateDDLBtn').disabled = false;
                document.getElementById('bq_ddl_preview').style.display = 'none';
            });
    }
}

function generateDDLFromSchema() {
    const schemaText = document.getElementById('browse_json_schema').textContent;
    const bq_project_id = document.getElementById('bq_project_id_browse').value;
    const bq_dataset_id = document.getElementById('bq_dataset_id_browse').value;
    const bq_table_name = document.getElementById('bq_table_name_browse').value;
    fetch('/generate_bq_ddl_from_schema', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            schema: schemaText,
            bq_project_id: bq_project_id,
            bq_dataset_id: bq_dataset_id,
            bq_table_name: bq_table_name
        })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('bq_ddl_preview').style.display = 'block';
        document.getElementById('bq_ddl_preview').querySelector('pre').textContent = data.ddl;
        // Optional: enable download
        let blob = new Blob([data.ddl], {type: "text/sql"});
        let url = URL.createObjectURL(blob);
        let downloadBtn = document.getElementById('downloadDDLBtn');
        downloadBtn.href = url;
        downloadBtn.style.display = 'inline-block';
    });
}

function updateBQTableNameFromJSON() {
    try {
        const jsonText = document.getElementById('json_schema').value;
        if (jsonText.trim() === "") {
            document.getElementById('bq_table_name').value = "";
            return;
        }
        const schema = JSON.parse(jsonText);
        if (schema.table_name !== undefined) {
            document.getElementById('bq_table_name').value = schema.table_name;
        } else {
            document.getElementById('bq_table_name').value = "";
        }
    } catch (e) {
        document.getElementById('bq_table_name').value = "";
    }
}

function clearTextarea(id) {
    document.getElementById(id).value = "";
    if (id === "json_schema") {
        updateBQTableNameFromJSON();
    }
}

function onDatabaseChange() {
    const dbSystem = "{{ db_system }}";
    const db = document.getElementById('browse_database').value;
    document.getElementById('browse_schema').innerHTML = '<option value="">Select schema...</option>';
    document.getElementById('browse_table').innerHTML = '<option value="">Select table...</option>';
    clearJsonSchema();
    if (!db) return;
    fetch(`/get_schemas?db_system=${encodeURIComponent(dbSystem)}&database=${encodeURIComponent(db)}`)
        .then(response => response.json())
        .then(data => {
            let options = '<option value="">Select schema...</option>';
            for (const schema of data.schemas) {
                options += `<option value="${schema}">${schema}</option>`;
            }
            document.getElementById('browse_schema').innerHTML = options;
        });
}

function onSchemaChange() {
    const dbSystem = "{{ db_system }}";
    const db = document.getElementById('browse_database').value;
    const schema = document.getElementById('browse_schema').value;
    document.getElementById('browse_table').innerHTML = '<option value="">Select table...</option>';
    clearJsonSchema();
    if (!db || !schema) return;
    let url = "";
    if (dbSystem === "postgresql") {
        url = `/get_postgres_tables?database=${encodeURIComponent(db)}&schema=${encodeURIComponent(schema)}`;
    } else {
        url = `/get_tables?db_system=${encodeURIComponent(dbSystem)}&database=${encodeURIComponent(db)}&schema=${encodeURIComponent(schema)}`;
    }
    fetch(url)
        .then(response => response.json())
        .then(data => {
            let options = '<option value="">Select table...</option>';
            // For /get_postgres_tables, data is a list; for /get_tables, data.tables
            let tables = data.tables || data;
            for (const tbl of tables) {
                options += `<option value="${tbl}">${tbl}</option>`;
            }
            document.getElementById('browse_table').innerHTML = options;
        });
}
</script>
</body>
</html>
